<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "-//OASIS//DTD DITA Task//EN" "task.dtd">
<task id="configuring_ldap_multiple_docker" xml:lang="en-us">
    <title>Configuring additional LDAP servers on Docker</title>
    <shortdesc>You can configure the Sametime server to connect to two or more LDAP
            servers.<draft-comment>Tagged as not ready</draft-comment></shortdesc>
    <taskbody>
        <prereq id="prereq_sfs_c4y_mvb">When you connect to more than one LDAP server, it is
            important for the names to be unique. If you are trying to achieve high availability to
            the same directory, use a load balancer to front-end the connection between the multiple
            LDAP servers. <ul id="ul_all_24y_mvb">
                <li>Configure the cluster for the first LDAP server. This must be done when the
                    cluster was installed. </li>
                <li>You must know the host name, port and optional bind credentials for each LDAP
                    server. </li>
                <li>If you are using a secure connection to LDAP, the LDAP server’s certificate for
                    each server must be stored in the same .p12 trust store file. You must create a
                    secret containing the trust store that holds each LDAP server’s certificate.
                </li>
            </ul></prereq>
        <context id="context_ex1_g4y_mvb">
            <p>When more than one LDAP is defined in an environment, they are searched in the order
                defined in the StCommunityConfig.xml and <filepath>UserInfoConfig.xml</filepath>
                files. When you define each LDAP server, the order in which they are listed in the
                configuration is the same order in which they are searched. </p>
            <p>The process described in this procedure involves copying the
                    <filepath>StCommunityConfig.xml</filepath> and UserInfoConfig.xml files from the
                Sametime community (chat) container. These copied configurations overrides the
                default LDAP configuration settings. The LDAP servers are defined within each
                configuration file. </p>
            <p>Docker-compose commands are used to pull the existing configuration files from the
                Sametime server to your local machine. Modify these files locally with the required
                settings, then add a volume under the community section of the
                    <filepath>docker-compose.yml</filepath> file to enable the modified settings. </p>
            <p>This procedure is to configure Sametime to connect to two or more separate LDAP
                servers that have unique names.</p>
        </context>
        <steps id="steps_ofs_n4y_mvb">
            <step>
                <cmd>Change to the <filepath>sametime_installation_directory</filepath> directory.
                </cmd>
            </step>
            <step>
                <cmd>Identify the chat-server container ID by running the command 'docker container
                    ls' and finding the chat-server IMAGE. The <parmname>NAME</parmname> is the
                    container name, as an example: sametime-community-1. </cmd>
            </step>
            <step>
                <cmd>Pull a copy of the StCommunityConfig.xml and UserInfoConfig.xml from the
                    chat-server container by running the below command, where
                        <varname>container_name</varname> is the container name for the chat-server
                    identified in step 2.</cmd>
                <info>
                    <codeblock id="codeblock_zqq_1py_mvb">
docker cp &lt;container_name>:/local/notesdata/UserInfoConfig.xml . 
</codeblock>
                    <codeblock id="codeblock_jvp_hpy_mvb">
docker cp &lt;container_name>:/local/notesdata/StCommunityConfig.xml .</codeblock>
                </info>
            </step>
            <step>
                <cmd> Find the base64 encoded value of your bind credentials. If you are using an
                    authenticated bind, issue the following command in a Linux shell that contains
                    your user name and password separated by a colon. The resulting value is used in
                    a later step.</cmd>
                <info>
                    <codeblock id="codeblock_atj_jpy_mvb">echo -n “username:password” | base64 -d</codeblock>
                    <p>If the Bind DN is CN=bind,O=Example and the password is password, then the
                        command is:</p>
                    <codeblock id="codeblock_pcw_npy_mvb">echo -n “CN=bind,O=Example:password” | base64 -d </codeblock>
                </info>
            </step>
            <step>
                <cmd> Use a text editor to open your local copy of UserInfoConfig.xml in edit mode.
                </cmd>
            </step>
            <step>
                <cmd>Duplicate the line that begins with <codeph>StorageDetails</codeph>. </cmd>
            </step>
            <step>
                <cmd>The order in which you list your <codeph>StorageDetails</codeph> statement is
                    the search order to be used.</cmd>
                <info>
                    <parml id="parml_lcc_spy_mvb">
                        <plentry>
                            <pt>HostName</pt>
                            <pd>The fully qualified host name or IP address of the second LDAP
                                server. </pd>
                        </plentry>
                        <plentry>
                            <pt>Port</pt>
                            <pd>If using unsecured LDAP, specify the port number used by LDAP. If
                                you are using secure LDAP, you don't need to modify this field.</pd>
                        </plentry>
                        <plentry>
                            <pt>UserName</pt>
                            <pd>Set this field to empty double-quotes ( “” ). </pd>
                        </plentry>
                        <plentry>
                            <pt>Password</pt>
                            <pd>Set this field to empty double-quotes (“”). If using an
                                authenticated bind, add a new parameter after UserName and Password
                                called UserEncodedAuth= and set it to the value that was determined
                                in a previous step. </pd>
                        </plentry>
                        <plentry>
                            <pt>BaseDN</pt>
                            <pd>Define a base DN for searching the directory. If left blank, the
                                entire directory is searched. </pd>
                        </plentry>
                        <plentry>
                            <pt>SearchFilter</pt>
                            <pd>SearchFilter Modify the search filter if needed. The defaults work
                                well with Domino LDAP.</pd>
                        </plentry>
                    </parml>
                </info>
                <info>You can make other changes to the business cards configuration if needed at
                    this time. When finished, save and close the file.</info>
            </step>
            <step>
                <cmd>When finished, save and close the <filepath>UserInfoConfig.xml</filepath>
                        file.<draft-comment author="debra.taylor">Isn't this the same as above
                        stmt?</draft-comment></cmd>
            </step>
            <step>
                <cmd>Edit the <filepath>StCommunityConfig.xml</filepath> file with a text editor and
                    make the following changes.</cmd>
                <substeps id="substeps_kgm_4qy_mvb">
                    <substep>
                        <cmd> Within the &lt;LDAP> section, duplicate the line that begins with
                            &lt;Connection Hostname. </cmd>
                    </substep>
                    <substep>
                        <cmd>Modify the new line to contain the details of the second LDAP server.
                        </cmd>
                    </substep>
                    <substep>
                        <cmd>Modify the SearchOrder parameter for the additional LDAP server to a
                            unique number. This must match the search order you selected for
                                <filepath>UserInfoConfig.xml</filepath>.</cmd>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Save and close the <filepath>StCommunityConfig.xml</filepath> file.</cmd>
            </step>
            <step>
                <cmd>Edit the docker-compose.yaml by adding the following under the community
                    section: </cmd>
                <info>
                    <codeblock id="codeblock_jtx_tqy_mvb">
volumes:
  - ./StCommunityConfig.xml:/local/notesdata/StCommunityConfig.xml
  - ./UserInfoConfig.xml:/local/notesdata/UserInfoConfig.xml </codeblock>
                </info>
            </step>
            <step>
                <cmd>Restart the server to apply the changes by running the following commands. </cmd>
                <info>
                    <codeblock id="codeblock_vsw_wqy_mvb">
docker-compose down
docker-compose up -d</codeblock>
                </info>
            </step>
        </steps>
    </taskbody>
</task>
