<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "-//OASIS//DTD DITA Task//EN" "task.dtd">
<task id="t_troubleshooting_ldap_kubernetes">
    <title>Troubleshooting LDAP on the  community pod </title>
    <shortdesc>
        <draft-comment author="debra.taylor">tagged as not ready</draft-comment>
    </shortdesc>
    <taskbody>
        <context>
            <p>If you are having difficulty connecting to a secure LDAP server, perform the
                following troubleshooting steps.</p>
        </context>
        <steps>
            <step>
                <cmd>Log into the community pod.</cmd>
                <substeps id="substeps_rdx_rd2_lvb">
                    <substep>
                        <cmd>Find the name of the community pod using the <cmdname>kubectl get
                                pods</cmdname> command. The results shows the pod names which
                            contains hashes.</cmd>
                    </substep>
                    <substep>
                        <cmd>Run the following command to log into the community pod. Include the
                            pod name.</cmd>
                        <info>
                            <codeblock id="codeblock_tq1_c22_lvb">
<varname>pod_name</varname> kubectl exec -it <varname>pod_name</varname> --container=community -– bash </codeblock>
                        </info>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Confirm that the community pod is receiving the trust store. Look for the
                        <filepath>ldaptruststore.p12</filepath> file in
                        <filepath>/local/notesdata</filepath> directory.</cmd>
                <choices id="choices_bq3_v5w_mvb">
                    <choice>If the file is present, continue to the next step.</choice>
                    <choice>If the file is missing, the LDAP secret is not being read properly.
                    </choice>
                </choices>
                <substeps id="substeps_drv_k22_lvb">
                    <substep>
                        <cmd>Confirm that LDAP secret has been created in the correct namespace if
                            using namespaces.</cmd>
                    </substep>
                    <substep>
                        <cmd>Open the <filepath>values.yaml</filepath> file and confirm that the
                            LDAP secret name is specified correctly in the <codeph>ldapConfigSecret:
                                "ldap-config-secret"</codeph> format.</cmd>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Confirm that the <filepath>sametime.ini</filepath> and
                        <filepath>UserInfoConfig.xml</filepath> files are updated.</cmd>
                <substeps id="substeps_r2c_dj2_lvb">
                    <substep>
                        <cmd>Open the <filepath> /local/notesdata/sametime.ini</filepath> file in
                            the community pod. and confirm the <parmname>LDAP TLS</parmname>
                            settings are present.</cmd>
                        <info>Locate the following statements in the
                            file:<codeblock id="codeblock_fp4_nj2_lvb"> 
STLDAP_TLS_TRUST_STORE_TYPE=p12 
STLDAP_TLS_TRUST_STORE_FILE = /local/notesdata/ldaptruststore.p12 </codeblock>The
                            file name and path are hard coded and should not changed.
                            <codeblock id="codeblock_exw_qj2_lvb">STLDAP_TLS_TRUST_STORE_PASSWORD= thepassword</codeblock>This
                            should be your actual password for the trust store. If these are
                            missing, confirm the <filepath>values.yaml</filepath> settings are
                            present as mentioned in the confirm you have the correct configuration
                            details step.</info>
                    </substep>
                    <substep>
                        <cmd>Open the <filepath>/local/notesdata/UserInfoConfig.xml</filepath> and
                            confirm that you see the correct details in the <codeph>&lt;Storage
                                Details></codeph> section for the host name and port of the LDAP
                            server. </cmd>
                        <info>Confirm that the below line is present, where “thepassword” is your
                            trust store
                            password:<codeblock id="codeblock_j5p_nl2_lvb">&lt;SslProperties KeyStorePath="/local/notesdata/ldaptruststore.p12" KeyStorePassword="<varname>password</varname>" /></codeblock>
                            If anything in this section is missing, examine the settings in the
                                <filepath>values.yaml</filepath> file for accuracy as decribed in
                            the next step.</info>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Confirm you have correct configuration details .</cmd>
                <substeps id="substeps_oys_wl2_lvb">
                    <substep>
                        <cmd>Confirm your other values in the <filepath>values.yaml</filepath>
                            pertaining to LDAP: </cmd>
                        <info>
                            <ul id="ul_j2j_1m2_lvb">
                                <li><codeph>ldapHost:</codeph><codeblock id="codeblock_z5b_fm2_lvb">
ldapHost: <varname>server_host_name</varname>
ldapPort: "636"
ldapTls: true</codeblock> Where <varname>server_host_name</varname>
                                    should be the LDAP server host name or IP address.</li>
                            </ul>
                        </info>
                    </substep>
                    <substep>
                        <cmd>Check the bind credentials in the
                                <parmname>sametime-global-secrets</parmname>, they are base64
                            encoded. First, issue the command: <codeph>kubectl edit secret
                                sametime-global-secrets </codeph></cmd>
                        <info>Locate the lines beginning with <codeph>LdapBindEntryDn</codeph> and
                                <codeph>LdapBindEntryPassword</codeph>. Take the value of each
                            setting and base64 decode them, they should be your Bind DN and the Bind
                            password. If these are wrong, then base64 encode them. To decode the
                            values, issue the following
                            command:<codeblock id="codeblock_h2w_svw_mvb"> echo -n ‘value’ | base64 -d </codeblock>Where
                            ‘value’ is the encoded value in the secret. </info>
                    </substep>
                    <substep>
                        <cmd>If you need to change the credentials, you can set it to the base64
                            encoded value of the correct Bind name and password, directly in the
                            secret, but it should also be set in the template file as well. If you
                            fail to update the template file, then your existing secrets are
                            overridden when you run a <cmdname>helm upgrade</cmdname> command. The
                            template file is located where the helm directory was saved, and it is
                            found under /helm/templates/sametime-secrets.yaml </cmd>
                        <info>To change the Bind credentials, see <xref format="dita" scope="local"
                                href="configuring_ldap_password.dita"/>. For more information on
                            secrets, see the  <xref format="dita" scope="local"
                                href="managing_secrets_kubernetes.dita"/>and <xref format="dita"
                                scope="local" href="secrets_modify.dita"/> topics.</info>
                    </substep>
                    <substep>
                        <cmd> If you are overriding the default configuration using an
                            extra-community-config secret, there are additional steps to take to
                            correct the Bind DN. See  <xref format="dita" scope="local"
                                href="configuring_ldap_password.dita"/>.</cmd>
                    </substep>
                </substeps>
            </step>
            <step>
                <cmd>Confirm TLS is negotiating properly between Sametime and LDAP </cmd>
                <info>
                    <ul id="ul_grw_3pd_lvb">
                        <li>In Sametime 12 only TLS 1.2 is enabled by default. If the LDAP server
                            you are connecting to doesnn't support TLS 1.2, then you need to
                            override the default configuration.</li>
                        <li>Sametime connects to LDAP attempting to negotiate TLS with the following
                            ciphers: <lines id="lines_kld_xww_mvb">
RSA_WITH_AES_256_GCM_SHA384 (0x009D)
RSA_WITH_AES_128_CBC_SHA (0x002F) </lines><p>Support for at least one of
                                the ciphers might need to be added to your LDAP server, such is the
                                case for HCL Domino 12.0.2, for details see <xref
                                    href="https://support.hcltechsw.com/csm?id=kb_article&amp;sysparm_article=KB0099644"
                                    format="html" scope="external">Sametime 12.0 TLS required
                                    ciphers to connect to Domino 12.0.2 LDAP</xref>
                            </p></li>
                        <li>There is a known issue when using a newer version of keytool to create
                            the trust store, Sametime is unable to read it. To work around the
                            problem, recreate the trust store with keytool and add the argument:
                                <codeph>-J-Dkeystore.pkcs12.legacy</codeph> to the command. For more
                            details, see the   <xref
                                href="https://support.hcltechsw.com/csm?id=kb_article&amp;sysparm_article=KB0101354"
                                format="html" scope="external">Sametime unable to read trust store
                                causing LDAP connection to fail</xref> article.</li>
                        <li>To determine if your TLS is not negotiating and finding a common cipher
                            suite enable debug. Start with VP_LDAP_TRACE=1 and ST_TLS_DEBUG=1. See
                                the<xref href="t_enabling_community_debug.dita" scope="local"
                                format="dita"/> topic.</li>
                    </ul>
                </info>
            </step>
            <step>
                <cmd>By default, the community pod connects to LDAP on the pod IP address range, and
                    the firewall should be configured to permit this traffic. If you are unable to
                    open up the entire pod IP range to LDAP, consider implementing a network address
                    translation, or IP Masquerade solution, which will give the traffic from the
                    pods an IP in a range of your choosing. </cmd>
                <info>An example of this is the Google Kubernetes Engine IP masquerade agent
                    solution. For more information, see the  <xref
                        href="https://cloud.google.com/kubernetes-engine/docs/concepts/ip-masquerade-agent"
                        format="html" scope="external">IP masquerade agent</xref> Google Cloud
                    topic. Each cloud provider has an unique solution, see your vendor’s
                    documentation for more details. </info>
            </step>
            <step>
                <cmd>The community pod must resolve the host name of the LDAP server, or you can
                    configure the IP address instead. If the host name of the LDAP server does not
                    resolve in DNS, you can configure Host Aliases for the Community pod.</cmd>
                <info>See the <xref
                        href="https://help.hcltechsw.com/sametime/12/admin/t_meetings_kubernetes.html"
                        format="html" scope="external">Configuring host aliases for Kubernetes
                        deployments</xref> article for steps.</info>
            </step>
            <step>
                <cmd>Netstat is installed on the community pod and can be helpful to understanding
                    if the connectivity is succeeding or not succeeding.</cmd>
                <info>To use netstat on the community pod enter the command:
                    <codeblock id="codeblock_ekz_cyw_mvb">netstat -an | grep 636 </codeblock>Substitute
                    your secure LDAP port number if you are not using port 636.</info>
            </step>
            <step>
                <cmd>You might find that the default settings for LDAP are incompatible with your
                    LDAP implementation and are causing problems</cmd>
                <info>
                    <ul id="ul_gmq_kpd_lvb">
                        <li>Sametime 12 connects with multiple connections, the login, resolve and
                            search connections uses the same settings. These settings are configured
                            in the StCommunityConfig.xml, which are pulled from the
                                <filepath>values.yaml</filepath> file and
                                <parmname>sametime-global-secrets</parmname>. These can be
                            overwritten by the <parmname>extra-community-configs</parmname>
                            secret.</li>
                        <li>The UserInfo task (business cards) uses different settings. These
                            settings are in the<filepath> UserInfoConfig.xml</filepath> file and are
                            also pulled from the <filepath>values.yaml</filepath> file and can be
                            overwritten by the <parmname>extra-community-configs</parmname> secret.
                        </li>
                    </ul>
                    <!--<p>To look at the default settings, follow the instructions, steps 1 through 5 in the topic “Overriding the default LDAP settings with extra-community-config secret.” These steps bring a copy of the two files to your local machine where you can review them. Ensure that the LDAP filters are valid for your LDAP environment. If they are not, then you need to modify these files and override the default configuration with an <parmname>extra-community-config</parmname> secret. </p>-->
                    <p>It is also possible to create a custom java class file to transform the LDAP
                        searches for more efficient requests to LDAP. See <xref
                            href="config_class_file_kubernetes.dita" scope="local" format="dita"/>
                        for more details.</p>
                </info>
            </step>
        </steps>
    </taskbody>
</task>
